<section id="join" class="py-24 px-6 bg-[#0a0a0a]">
    <div class="max-w-md mx-auto">
        <h2 class="text-4xl font-bold text-center mb-8 italic text-[#FCA311] font-['Oswald'] uppercase">Join Movement</h2>
        
        <div id="counterBox" class="bg-[#FCA311]/10 border border-[#FCA311] p-4 mb-6 rounded text-center hidden">
            <p class="text-[#FCA311] text-xs font-bold uppercase tracking-widest">
                Current Availability: <span id="spotsLeft" class="text-white text-lg ml-2">8</span> Spots Left
            </p>
        </div>

        <form id="regForm" class="space-y-4">
            <div>
                <label class="block text-[10px] text-[#FCA311] font-bold uppercase mb-1 tracking-wider">Full Name</label>
                <input type="text" id="name" placeholder="YOUR NAME" required class="w-full bg-[#151515] border border-[#333] text-white p-4 rounded outline-none focus:border-[#FCA311]">
            </div>

            <div>
                <label class="block text-[10px] text-[#FCA311] font-bold uppercase mb-1 tracking-wider">Email Address</label>
                <input type="email" id="email" placeholder="EMAIL@EXAMPLE.COM" required class="w-full bg-[#151515] border border-[#333] text-white p-4 rounded outline-none focus:border-[#FCA311]">
            </div>

            <div>
                <label class="block text-[10px] text-[#FCA311] font-bold uppercase mb-1 tracking-wider">Phone Number</label>
                <input type="tel" id="phone" placeholder="+251..." required class="w-full bg-[#151515] border border-[#333] text-white p-4 rounded outline-none focus:border-[#FCA311]">
            </div>

            <!-- FIXED MOBILE GRID -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] text-[#FCA311] font-bold uppercase mb-1 tracking-wider">Country</label>
                    <select id="country" onchange="updateCities()" required class="w-full bg-[#151515] border border-[#333] text-white p-4 rounded outline-none appearance-none">
                        <option value="" disabled selected>SELECT</option>
                        <option value="Ethiopia">Ethiopia</option>
                        <option value="Germany">Germany</option>
                        <option value="USA">USA</option>
                        <option value="Netherlands">Netherlands</option>
                        <option value="Kenya">Kenya</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] text-[#FCA311] font-bold uppercase mb-1 tracking-wider">City</label>
                    <select id="city" onchange="updateSubCities()" required class="w-full bg-[#151515] border border-[#333] text-white p-4 rounded outline-none appearance-none">
                        <option value="" disabled selected>SELECT</option>
                    </select>
                </div>
            </div>

            <div id="subCityGroup" class="hidden">
                <label class="block text-[10px] text-[#FCA311] font-bold uppercase mb-1 tracking-wider">Specific Spot / Area</label>
                <select id="subCity" onchange="checkSpots()" class="w-full bg-[#151515] border border-[#333] text-white p-4 rounded outline-none appearance-none">
                    <option value="" disabled selected>SELECT AREA</option>
                </select>
            </div>

            <button type="submit" id="subBtn" class="w-full bg-[#FCA311] text-black font-black uppercase tracking-widest py-5 rounded mt-4 hover:bg-white transition-colors duration-300">
                Confirm Registration
            </button>
        </form>
    </div>
</section>

<script>
    // Logic Configuration
    const SHEETDB_API = "https://sheetdb.io/api/v1/9q45d3e7oe5ks";
    const WHATSAPP_NUM = "251910884585";
    const LIMIT_PER_SPOT = 8;

    const locations = {
        "Ethiopia": { 
            "Addis Ababa": ["Bole", "Ayat", "Megenagna", "Mexico", "Haile Garment", "Old Airport"],
            "Hawassa": ["Main Center"],
            "Adama": ["Main Center"]
        },
        "Germany": { "Berlin": ["Mitte"] },
        "USA": { "Dallas": ["Downtown"] },
        "Netherlands": { "Amsterdam": ["Zuid"] },
        "Kenya": { "Nairobi": ["Westlands"] }
    };

    function resetButton() {
        const btn = document.getElementById('subBtn');

        btn.disabled = false;
        btn.innerText = "CONFIRM REGISTRATION";
        btn.style.backgroundColor = "#FCA311";
    }

    function updateCities() {
        const country = document.getElementById('country').value;
        const citySel = document.getElementById('city');
        const subCitySel = document.getElementById('subCity');

        citySel.innerHTML = '<option value="" disabled selected>SELECT</option>';
        subCitySel.innerHTML = '<option value="" disabled selected>SELECT AREA</option>';

        document.getElementById('subCityGroup').classList.add('hidden');
        document.getElementById('counterBox').classList.add('hidden');

        resetButton();

        if(locations[country]) {
            Object.keys(locations[country]).forEach(city => {
                let opt = new Option(city.toUpperCase(), city);
                citySel.add(opt);
            });
        }
    }

    function updateSubCities() {
        const country = document.getElementById('country').value;
        const city = document.getElementById('city').value;

        const subCitySel = document.getElementById('subCity');
        const group = document.getElementById('subCityGroup');

        subCitySel.innerHTML = '<option value="" disabled selected>SELECT AREA</option>';

        document.getElementById('counterBox').classList.add('hidden');

        resetButton();

        if (!locations[country] || !locations[country][city]) {
            group.classList.add('hidden');
            return;
        }

        const areas = locations[country][city];

        if (areas.length > 0) {
            areas.forEach(area => {
                let opt = new Option(area.toUpperCase(), area);
                subCitySel.add(opt);
            });

            group.classList.remove('hidden');
            subCitySel.required = true;

        } else {
            group.classList.add('hidden');
            subCitySel.required = false;
        }
    }

    async function checkSpots() {
        const city = document.getElementById('city').value;
        const spot = document.getElementById('subCity').value;
        const counter = document.getElementById('counterBox');
        const btn = document.getElementById('subBtn');

        if (city === "Addis Ababa" && spot) {
            counter.classList.remove('hidden');
            try {
                const response = await fetch(`${SHEETDB_API}/search?City=${city}&Spot=${spot}`);
                const data = await response.json();
                const remaining = LIMIT_PER_SPOT - data.length;
                
                document.getElementById('spotsLeft').innerText = remaining > 0 ? remaining : 0;
                
                if (remaining <= 0) {
                    btn.disabled = true;
                    btn.innerText = "LOCATION FULL";
                    btn.style.backgroundColor = "#444";
                } else {
                    resetButton();
                }
            } catch (err) { console.error("Counter Error:", err); }
        }
    }

    document.getElementById('regForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('subBtn');
        const oldText = btn.innerText;
        btn.innerText = "PROCESSING...";

        const formData = {
            "Name": document.getElementById('name').value,
            "Email": document.getElementById('email').value,
            "Phone": document.getElementById('phone').value,
            "Country": document.getElementById('country').value,
            "City": document.getElementById('city').value,
            "Spot": document.getElementById('subCity').value || "General",
            "Registration Date": new Date().toLocaleDateString(),
            "Registration Time": new Date().toLocaleTimeString()
        };

        try {
            await fetch(SHEETDB_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [formData] })
            });
            
            const msg = `Hello! I just registered for Bible %26 Coffee.%0A%0A*Name:* ${formData.Name}%0A*Location:* ${formData.City} - ${formData.Spot}`;
            window.open(`https://wa.me/${WHATSAPP_NUM}?text=${msg}`, '_blank');
            
            alert("Registration Submitted Successfully!");
            btn.innerText = oldText;
            document.getElementById('regForm').reset();
            resetButton();
            checkSpots();

        } catch (err) {
            alert("Submission failed. Please try again.");
            btn.innerText = oldText;
        }
    };
</script>
