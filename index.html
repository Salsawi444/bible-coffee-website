<script>
        const API_URL = "https://sheetdb.io/api/v1/9q45d3e7oe5ks";
        const ADMIN_PHONE = "251910884585"; 

        function openLightbox(imgSrc) {
            document.getElementById('lightbox-img').src = imgSrc;
            document.getElementById('lightbox').style.display = 'flex';
        }

        function toggleMerch() {
            const mSection = document.getElementById('merch');
            mSection.style.display = 'block';
            mSection.scrollIntoView({ behavior: 'smooth' });
        }

        const geoData = {
            "Ethiopia": ["Addis Ababa", "Hawassa", "Adama", "Bishoftu"],
            "Germany": ["Frankfurt", "Munich"],
            "Netherlands": ["Amsterdam", "Rotterdam"],
            "Sweden": ["Stockholm"]
        };

        function updateCities() {
            const country = document.getElementById('userCountry').value;
            const citySel = document.getElementById('userCity');
            citySel.innerHTML = '<option value="" disabled selected>SELECT CITY</option>';
            geoData[country].forEach(city => {
                let opt = document.createElement('option');
                opt.value = city; opt.textContent = city.toUpperCase();
                citySel.appendChild(opt);
            });
        }

        async function updateSpecificLocations() {
            const city = document.getElementById('userCity').value;
            const locSel = document.getElementById('userLocation');
            if (city === "Addis Ababa") {
                locSel.innerHTML = '<option disabled>LOADING spots...</option>';
                const res = await fetch(API_URL);
                const data = await res.json();
                locSel.innerHTML = '<option value="" disabled selected>SELECT ADDIS SPOT</option>';
                ["Ayat", "Haile Garment", "Mexico"].forEach(g => {
                    const count = data.filter(r => r.Location === g).length;
                    let opt = document.createElement('option');
                    opt.value = g; opt.disabled = count >= 8;
                    opt.textContent = `${g.toUpperCase()} (${8-count} SPOTS LEFT)`;
                    locSel.appendChild(opt);
                });
            } else if (city) {
                locSel.innerHTML = '<option value="General Fellowship Spot" selected>GENERAL FELLOWSHIP SPOT</option>';
            }
        }

        document.getElementById('mainRegForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "SAVING...";

            const now = new Date();
            const regDate = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const regTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            const name = document.getElementById('userName').value;
            const city = document.getElementById('userCity').value;
            const location = document.getElementById('userLocation').value;

            const formData = {
                Name: name,
                Email: document.getElementById('userEmail').value,
                Phone: document.getElementById('userPhone').value,
                Country: document.getElementById('userCountry').value,
                City: city,
                Location: location,
                "Registration Date": regDate,
                "Registration Time": regTime
            };

            try {
                // 1. Save to Google Sheets
                await fetch(API_URL, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ data: [formData] }) 
                });
                
                // 2. Construct Clean WhatsApp Message
                const rawMsg = `Hello Bible & Coffee! ‚òïÔ∏èüìñ\n\nI just registered for the movement.\n\n*My Details:*\n- Name: ${name}\n- City: ${city}\n- Spot: ${location}\n\nRegistration confirmed on ${regDate}. See you there!`;
                
                const encodedMsg = encodeURIComponent(rawMsg);
                
                // 3. Open WhatsApp
                window.open(`https://wa.me/${ADMIN_PHONE}?text=${encodedMsg}`, '_blank');
                
                // 4. Reset Form
                document.getElementById('mainRegForm').reset();
                btn.innerText = "Confirm Registration";
                window.location.hash = "home";
                alert("Registration Complete! Check your WhatsApp to send the confirmation.");
            } catch (err) { 
                alert("Connection error. Please try again."); 
                btn.innerText = "Confirm Registration"; 
            }
        };
        lucide.createIcons();
    </script>
